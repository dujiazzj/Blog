---
layout: post
title: TeamTalk
category: 项目之路
---

#这是在蘑菇街的第一个项目，还在进行中，待我填完所有坑再和大家分享。敬请期待！

##IM项目心得

###在线状态维护

###封装Socket连接的数据请求接口（暂且这么叫）
在TeamTalk这个项目中，原先的代码几乎所有的网络数据请求都是通过这样一个模式：
	
	在某个地方往IO中写入数据包--->IO收到服务器返回的数据包---->协议头解析，根据serviceID和commandID分发到相应的业务模块取处理--->根据commandID广播通知----->注册此通知的实例执行相应的操作
	
这里最主要用到的就是观察者模式，观察者模式个人认为比较适用用一对多的情况，就比如说在登录成功之后可以发一个登录成功的通知，应该可能很多实例会因为用户登录成功而有所动作，在这种情况下用观察者模式是比较合适的。而比如一个获取最近联系人的接口，发起请求成功返回数据之后，实际上需要做出相应动作的就是最近联系人列表的Module，在这种清空下，观察者模式就不是那么方便了。滥用观察者模式，导致的问题就是你会有一堆需要维护的通知，到后面你会不知道哪个通知是哪个，而且在调试的时候也会把你弄晕的。

以上模式还有一个不好的地方不知道你们有没有发现，椒乳IO返回的数据被拦截了，那么后面的操作都不会进行。这是非常有可能的！这里就需要一个延时处理，但是在原有的基础上添加一个延时处理是非常困难的，所有我果断写了自己的API机制。（俗称牛逼API）。哈哈哈哈哈哈！！！！

牛逼API机制分为三大部分：API协议，API调度中心，超级API。

API协议：所有的socket网络请求的API都应遵守的协议，包括超时时间，请求的serviceID，commandID，返回的serviceID，commandID。打包的block，解析的block。
	
API调度中心：注册接口，注册超时，接受数据包

超级API：（这个类不能被调用，只能用来继承）

API系统的具体实现细节先不说了，等到开源之后在具体聊聊（其实很简单。。。），虽然这个体系很简单，但个人觉得对整个项目的结构已经稳定性影响会很大，但是如果要替换上这个机制的话TeamTalk就要大开刀了，搞不好暂时休克。等有机会拿他儿子开刀看看。